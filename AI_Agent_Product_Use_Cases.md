# マルチテナントSaaSにおけるAIエージェント：戦略的ユースケースと実装ガイド

本ドキュメントでは、`amazon-bedrock-agentcore-samples` のアーキテクチャに基づき、プロダクトマネージャーおよびアーキテクト向けに、マルチテナントSaaS環境におけるAIエージェントの具体的なユースケースと、それを支える技術的実装を包括的に解説します。

## 1. アーキテクチャ概要と提供価値

本リポジトリのコードベース（AgentCore）は、以下のコアコンポーネントにより、**「セキュアで、テナントごとに最適化された、拡張性の高いAIエージェント」**の実装を可能にします。

*   **Tenant Awareness (`TenantAwareAgent`)**: テナント（顧客企業）ごとのプロンプト、モデル、ツールの動的な切り替え。
*   **Secure Gateway (`AgentCoreGateway`)**: SaaSの既存APIやAWSリソース（Lambda）への、テナント権限に基づいた安全なアクセス。
*   **Isolated Memory (`TenantIsolatedStorage`)**: テナント間で物理的に分離された会話履歴の保存（DynamoDB）。
*   **Identity Propagation (`TenantContext`)**: ユーザーIDとテナントIDをエージェントの全動作コンテキストに注入。

---

## 2. ビジネス戦略別ユースケース

SaaSプロダクトの成長戦略（Build, Expand, PLG, Embed）に基づき、20の具体的なユースケースを提案します。

### 戦略 A: Build (新規事業・新製品の創出)
**目的:** AIエージェントそのものをコアバリューとする新しい製品ラインを立ち上げ、新規顧客を獲得する。

| No. | ユースケース名 | 具体的なシナリオ | 実装の技術的裏付け (AgentCore) |
| :--- | :--- | :--- | :--- |
| 1 | **法務契約レビューエージェント** | 契約書PDFをアップロードし、企業固有のリスクポリシー（「損害賠償の上限なしはNG」など）に基づいて条項をチェック・修正案を提示。 | `TenantIsolatedStorage`により、機密性の高い契約データを論理的・物理的に完全分離。`TenantAwareAgent`で企業ごとのポリシーをSystem Promptに注入。 |
| 2 | **高度財務プランニング** | 会計知識のない経営者に対し、対話形式でキャッシュフロー予測や資金調達シミュレーションを実施。 | `AgentCoreGateway`を使用し、会計システムの生データAPIへ安全にアクセス。複雑な推論には高性能モデル（Claude 3.5 Sonnet）を割り当て。 |
| 3 | **採用スクリーニング担当** | 何千もの履歴書をJ.D.（職務記述書）と照合し、候補者のランク付けと面接質問案を自動生成。 | `TenantContext`により、人事部門（Recruiterロール）のみがアクセスできるよう制御。 |
| 4 | **レガシーコード移行アシスタント** | 古い言語（COBOL, VB等）のコードを現代的なスタックに変換し、テストコードも自動生成。 | `TenantAwareAgent`で、顧客が使用しているコーディング規約やライブラリバージョンをプロンプトに反映。 |
| 5 | **個別指導教育メンター** | 生徒の理解度や学習履歴に基づいて、パーソナライズされた問題作成と解説を行う。 | `TenantIsolatedStorage`に長期的な学習ログ（Memory）を蓄積し、成長に合わせて難易度を調整。 |

### 戦略 B: Expand (既存製品の拡張・アップセル)
**目的:** 既存のSaaS製品に新しいモジュールを追加し、ARPU（顧客単価）を向上させる。

| No. | ユースケース名 | 具体的なシナリオ | 実装の技術的裏付け (AgentCore) |
| :--- | :--- | :--- | :--- |
| 6 | **マーケティングコピーライター (CRM向け)** | 過去の成約メールやブランドガイドラインを学習し、キャンペーンメールの文面を自動生成。 | `AgentCoreGateway`経由でCRMの過去メール履歴を取得し、Few-shotプロンプティングの例として使用。 |
| 7 | **在庫発注オプティマイザー (ERP向け)** | 販売傾向と季節性を分析し、「いつ、何を、どれくらい」発注すべきか提案し、承認されればERPに発注登録。 | `AgentCoreGateway`の`register_api_tool`を使用し、ERPの在庫APIと発注APIをツールとしてエージェントに装備。 |
| 8 | **プロジェクトリスク予知 (PMツール向け)** | タスクの進捗状況、担当者の負荷、チャットの雰囲気から、プロジェクトの遅延リスクを早期に警告。 | `MCPProxy`パターンを使用し、PMツールの全アクティビティログをエージェントが継続的にモニタリング。 |
| 9 | **インテリジェント経費精算** | 領収書画像とカレンダー予定を突合し、「このタクシー代はA社訪問時のものですね？」と推測して申請データを作成。 | `AgentCoreGateway`でカレンダーAPIと経費APIを連携。画像認識（Visionモデル）を活用。 |
| 10 | **顧客対応品質コーチ (CCaaS向け)** | 通話録音を分析し、オペレーターに対して「もっと共感的な言葉を使いましょう」といった具体的なコーチングレポートを作成。 | `TenantIsolatedStorage`に評価基準を保存。管理者のみが閲覧できるよう`TenantContext`で権限管理。 |

### 戦略 C: PLG (Product-Led Growth / 成長と定着)
**目的:** ユーザーのオンボーディングを自動化し、カスタマーサクセスを実現する。

| No. | ユースケース名 | 具体的なシナリオ | 実装の技術的裏付け (AgentCore) |
| :--- | :--- | :--- | :--- |
| 11 | **オンボーディング・コンシェルジュ** | 「何から始めればいい？」という質問に対し、ユーザーの業種や役割に合わせて初期設定をガイドし、実際の画面操作（APIコール）も代行。 | `TenantContext`内の`user_id`やロール情報を参照し、未設定項目を特定。`TenantAwareAgent`で初心者向けプロンプトを使用。 |
| 12 | **機能ディスカバリーボット** | ユーザーが手作業で時間をかけている操作を検知し、「この一括処理機能を使うと便利です」と能動的に提案。 | ログ分析結果をトリガーにエージェントを起動。提案は軽量モデル（Haiku）で行いコスト抑制。 |
| 13 | **トラブルシューティング・バディ** | エラー発生時に、「設定Aが間違っています。ここをクリックして直しますか？」と解決策を提示。 | `AgentCoreGateway`でシステムログと設定値にアクセスし、原因を特定。 |
| 14 | **解約防止（Churn）アナリスト** | 顧客のログイン頻度や機能利用率の低下を検知し、CS担当者に「解約リスクあり」のアラートと対策案を通知。 | 内部向けエージェントとして実装。全テナントの統計データではなく、特定テナントの時系列変化に注目。 |
| 15 | **SQLレス・レポートビルダー** | 「先月の地域別売上グラフを見せて」と頼むだけで、ダッシュボードを自動構築・保存。 | 自然言語をSQLやダッシュボード設定JSONに変換。`TenantContext`によるデータアクセス制御が必須。 |

### 戦略 D: Embed & Enhance (既存機能への組み込み)
**目的:** 自然な形でAIを機能の一部として提供し、UXを向上させる（Invisible AI）。

| No. | ユースケース名 | 具体的なシナリオ | 実装の技術的裏付け (AgentCore) |
| :--- | :--- | :--- | :--- |
| 16 | **スマート検索 (NL2SQL)** | 複雑なフィルタ条件画面を使わず、「未対応かつ重要度高のチケット」と入力するだけで検索実行。 | `AgentCoreGateway`が検索APIをラップ。ユーザーの意図を検索クエリパラメータに変換。 |
| 17 | **会議・商談要約 (Summarizer)** | Zoom/Teamsの録画から、議事録とネクストアクションを自動抽出し、CRMの商談メモ欄に書き込む。 | テキスト処理に特化したモデルを選択。要約結果は`TenantIsolatedStorage`ではなくCRMへ直接保存。 |
| 18 | **データ入力自動化** | メール署名欄やWebサイトから会社情報・担当者情報を抽出し、マスターデータ登録を補助。 | クリップボードやブラウザ拡張からの入力を処理。 |
| 19 | **多言語リアルタイム翻訳** | チャットツールにおいて、異なる言語を話すメンバー間のメッセージを、文脈を汲んで翻訳。 | `TenantAwareAgent`で業界用語辞書（社内用語）をコンテキストとして持たせる。 |
| 20 | **ドキュメントQ&A** | 社内Wikiやマニュアルを検索対象とし、質問に対して回答と参照元リンクを提示。 | RAG（検索拡張生成）構成。Knowledge Baseへのアクセス権限を`TenantContext`で厳密に制御。 |

---

## 3. 業界別特化シナリオ

### FinTech (金融)
*   **不正検知解説:** AIがトランザクションのリスクスコア判定理由を自然言語で説明（Explainable AI）。
*   **技術要件:** `AgentCoreIdentity`による厳格な証跡管理と、`TenantIsolatedStorage`によるデータ主権の確保。

### HealthTech (医療・ヘルスケア)
*   **トリアージ支援:** 患者の問診票から緊急度を判定し、医師にサマリを提示。
*   **技術要件:** HIPAA準拠のためのテナント完全分離（Siloモデル）。Lambdaツール実行時のIAMロール分離（`tenant_role_mapping`）。

### DevTools (開発者向けツール)
*   **インフラ構成生成 (IaC Gen):** 「WebサーバーとDBで冗長構成にして」という指示からTerraform/CloudFormationコードを生成。
*   **技術要件:** 出力コードの品質担保のため、開発言語に特化したモデル設定を使用。

---

## 4. AgentCoreによる技術実装のポイント

上記のユースケースを実現するために、`src/` 内のコンポーネントは以下のように機能します。

1.  **マルチテナント・コンテキスト (`TenantContext`)**
    *   **役割:** ユーザーが「どのテナント」の「どの権限」で操作しているかを、リクエストの全ライフサイクルで保持します。
    *   **コード参照:** `src/tenant/tenant_context.py` の `extract_from_jwt` メソッド。これにより、A社のユーザーがB社のデータにアクセスすることを防ぎます。

2.  **動的エージェント設定 (`TenantAwareAgent`)**
    *   **役割:** プレミアムプランの顧客には高性能モデル、フリープランには軽量モデルを適用するなど、ビジネスルールをコード化します。
    *   **コード参照:** `src/tenant/tenant_aware_agent.py` の `get_agent_config`。`TenantContext`の情報に基づき、モデル(`model`)や利用可能なツール(`tools`)を動的に決定します。

3.  **セキュアなツール実行 (`AgentCoreGateway`)**
    *   **役割:** エージェントがSaaSの内部APIや外部サービスを操作する際、テナントごとの認証情報に変換して接続します。
    *   **コード参照:** `src/agentcore/agentcore_gateway.py`。
        *   **Lambda:** `tenant_role_mapping` を使い、テナント専用のIAMロールを引き受けて実行 (`AssumeRole`)。
        *   **API:** `X-Tenant-ID` ヘッダーの付与や、テナントごとのOAuthトークン利用。

4.  **分離された記憶領域 (`TenantIsolatedStorage`)**
    *   **役割:** 会話履歴や短期記憶を、テナントIDをパーティションキーとして物理的に分離して保存します。
    *   **コード参照:** `src/tenant/tenant_storage.py` の `save_conversation`。DynamoDBのキー設計（PK: `TENANT#{id}...`）により、データ漏洩リスクを最小化します。
